#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

usage() {
    cat <<EOF
Usage: $(basename "$0") <command>

Commands:
  start       Start an interactive Claude Code session
  build       Build all containers
  rebuild     Rebuild and restart (e.g. after allowlist changes)
  logs        Show tinyproxy logs
  test        Run isolation verification tests
  stop        Stop all running containers
  status      Show container status
EOF
}

case "${1:-}" in
    start)
        docker compose run --rm claude-code
        ;;
    build)
        docker compose build
        ;;
    rebuild)
        docker compose build
        docker compose up -d tinyproxy
        ;;
    logs)
        docker compose logs tinyproxy "${@:2}"
        ;;
    test)
        echo "--- Direct access (should fail/timeout) ---"
        docker compose run --rm claude-code -c \
            "curl -s --max-time 5 https://google.com" || true
        echo ""
        echo "--- Non-allowlisted via proxy (should get 403) ---"
        docker compose run --rm claude-code -c \
            "curl -s -x http://tinyproxy:8888 https://google.com" || true
        echo ""
        echo "--- Allowlisted via proxy (should succeed) ---"
        docker compose run --rm claude-code -c \
            "curl -s -x http://tinyproxy:8888 https://api.anthropic.com"
        ;;
    stop)
        docker compose down
        ;;
    status)
        docker compose ps
        ;;
    *)
        usage
        exit 1
        ;;
esac
